import * as bitcoinjs from 'bitcoinjs-lib';
import { Mnemonic } from '../src/app/core/bitcoinjs/mnemonic';
import { PsbtSigner } from '../src/app/core/psbt-signer';

describe('PsbtSigner', () => {

  it(`should not sign when mnemonic is different`, () => {
    const instance = new PsbtSigner;
    const text = '39:WTCYC2JBE2*SY8+RKO:39.QBL3-/2SVV1M5NDTZCYD93SRRDVW:TXVZUE.YIS1SJGJZER60H:ITCZ:-AJ8YD+W4EX.E/K*08NVE.V08EA9OUHAZ$./Q/8.453K9T0KJO:1.IHWYF955A78AXXF$-BK48A8D5IJGE2-2Z$NTIFLO+L7C5GGFX/BCZAI/J47LC70/2QJ3VWA+S$CE7QLN8YN-8XQ6QEYCVO7UI.R+JZLAVNW/CMA845R1504-6*V72X6X5AOQ7X32UKEA2-C+BT77KII2VPJ+90*72:6U-8XCIL5*$:HCGS/4:.F8O7QRR$K/3XSL+65JJQFQ8KENEHK*T8YRLLNXUB:7LH2A2V2+E0A5FNRE.TJUOFXO+UVK3VNDC4A9I0MQMTL1Q3GD:/3K3D-:VS115XQ1/IWAC+8OHEGK88NQY23JZIUEJ36FOYR6161*2VOQF9SLRZ+1H+BJIROYF:T3$F+2WOB95BV7H2$E2:IM/L+.J.M8275T7N.6NF1873O-J:KYV6J*GORGI$F::8KE*TZYY*ICXFAK3G5GW4JRHQ6UCYIHM:0DN*K0U89I:/O7T*1VHG2X78KERO4F3IYEXPSAW8+DJPQN/FN6-F3$';
    const mnemonic = Mnemonic.new(256);
    const purposeArray = [84, 49];
    const accountGapLimit = 10;
    const network = bitcoinjs.networks.testnet;

    expect(() => instance.sign(text, mnemonic, purposeArray, accountGapLimit, network)).toThrowError();
  });

  it(`should sign bip84`, () => {
    const instance = new PsbtSigner;
    const text = '39:WTCYC2JBE2*SY8+RKO:39.QBL3-/2SVV1M5NDTZCYD93SRRDVW:TXVZUE.YIS1SJGJZER60H:ITCZ:-AJ8YD+W4EX.E/K*08NVE.V08EA9OUHAZ$./Q/8.453K9T0KJO:1.IHWYF955A78AXXF$-BK48A8D5IJGE2-2Z$NTIFLO+L7C5GGFX/BCZAI/J47LC70/2QJ3VWA+S$CE7QLN8YN-8XQ6QEYCVO7UI.R+JZLAVNW/CMA845R1504-6*V72X6X5AOQ7X32UKEA2-C+BT77KII2VPJ+90*72:6U-8XCIL5*$:HCGS/4:.F8O7QRR$K/3XSL+65JJQFQ8KENEHK*T8YRLLNXUB:7LH2A2V2+E0A5FNRE.TJUOFXO+UVK3VNDC4A9I0MQMTL1Q3GD:/3K3D-:VS115XQ1/IWAC+8OHEGK88NQY23JZIUEJ36FOYR6161*2VOQF9SLRZ+1H+BJIROYF:T3$F+2WOB95BV7H2$E2:IM/L+.J.M8275T7N.6NF1873O-J:KYV6J*GORGI$F::8KE*TZYY*ICXFAK3G5GW4JRHQ6UCYIHM:0DN*K0U89I:/O7T*1VHG2X78KERO4F3IYEXPSAW8+DJPQN/FN6-F3$';
    const mnemonic = new Mnemonic();
    mnemonic.phrase = 'wool bullet crunch trend acoustic text swap flash video news bless second';
    const purposeArray = [84, 49];
    const accountGapLimit = 10;
    const network = bitcoinjs.networks.testnet;

    const result = instance.sign(text, mnemonic, purposeArray, accountGapLimit, network);

    expect(result.psbt.extractTransaction().toHex()).toEqual('0200000000010287124bb6e522443370b65eb7913a1fe6033f5bdd357ca5c12a4fece4ae60e66d0000000000fdffffff871dfd1e6fd0f88133787cc421047c8411685b343b06004da2af3be14a17308f0000000000fdffffff02b414000000000000160014ba1bfc0cb7fc5874f63e3ad5936aee4afdc43183a0860100000000001600148d00baeaf4d297116d3b2a1524437b82ff06808702483045022100d1c7bcce18258bce993af09dda892ede48d23b22112b8287a8bce97fed4e0be5022055436fd505343795c15c402c28942076ea72bca47b036a754e662ad290ab2fc4012102a30409b5885f5e43e30401ef0bbe65905579892c92621b72d05b8064c2ad364b0248304502210098eaa454b2a7acab6f530c61217b465f8b86cf62d5c23ad80e224897d2d836da02200635a14240fbee529c28d627e4339bc12275b97d8364adaf752aa36f2e9193a4012103696669edde1d54f90d724efa1484fd33a923ee7e0fcaa1d657919796cbdced753a312500');
  });

  it(`should sign bip49`, () => {
    const instance = new PsbtSigner;
    const text = '6HD4WNV*T5EAV.BCQI5LBOG72+U+P7RFGNE1HZGSE/Z7-TPSHX6U2H$ER4JL3VTLN365UI90GDQYIH0OOLV3WXB8IL-$LD4PGY28W7-+4-P2F7I2OR:PLMMB.RPNLB$RFODI2PRMG5EGBZMT5/IE-I-GY67:.UYES:YZHZND:1*JE8DBJKL6VX32ZJY3-98ZH54M$P.IYD4*./OFKB+YZQLHR02JLFM1JP*DRYMP.2-06D1Z/MMA4LB8KITNBGE.ZLDCFA-IMK$FP$EW9QSP51JBC1Q$36/.YZRVHPZUW99Q/TS7LL0OUSY0DB8WT$6:G3KRX$HFPSB2U4J.P6A6282H24JN-FA$P870AISXJKHHDU.-TF$RVROWP2LRGO:PMW1-L3SQ6MYW:3ES41AS4/U3R-O.W1JF-/4D.OG2PS30PBUS8927V$DTCSIVIBE47NYIZN4/RYN1FB0VMP7STL$.:L:M$OR00:-.-KOU$RPHRPTB0G-S7STS:O3N*43/TVS52HL0KSPJ3W+55GCM9BQRWVL.NQCHU$X3/6+SVG$4XR/I/E';
    const mnemonic = new Mnemonic();
    mnemonic.phrase = 'wool bullet crunch trend acoustic text swap flash video news bless second';
    const purposeArray = [84, 49];
    const accountGapLimit = 10;
    const network = bitcoinjs.networks.testnet;

    const result = instance.sign(text, mnemonic, purposeArray, accountGapLimit, network);

    expect(result.psbt.extractTransaction().toHex()).toEqual('02000000000101256bfaa174f671dc556f004494d39d2d19033a819d26633019067e5f304ca58e00000000171600149ce90e18d50ef1231aa2273aa6b58fc8ea81a39cfdffffff02d88501000000000017a914b67a49089139350726f6487c79a2aae7ca4ca65087a08601000000000017a91467ae08c2e294a55943d74bcad6697b66d8bc647f870247304402202320c247f7f7476578e211e6675503df7b3226aceececb4c141ae60ca69ee6d902201df4754e68869d05840aa9043ef052838e76393c6f8b1549c84abbb5155d1daa0121028e2bef18ac4f6b89ae7187f7e892f0de7596e3f274435b8581a166a5f495ad1967322500');
  });

});
